import{eD as w,gh as z,gv as v,gi as F,gj as d}from"./chunk-C4bXDfxA.js";import{CIMSymbolRasterizer as G}from"./chunk-BiBOaaz9.js";import{t as b,l as O}from"./chunk-CWLCWYeK.js";import"./chunk-D_yTKJJf.js";import"./chunk--6mYOZ3I.js";import"./chunk-D5CLXfjF.js";const h=new G(null),u=w(b.size),M=w(b.maxSize),S=w(b.lineWidth),R=1;async function V(n,t,o){const l=t?.size;let e=l!=null&&typeof l=="object"&&"width"in l?l.width:l,i=l!=null&&typeof l=="object"&&"height"in l?l.height:l;if(e==null||i==null)if(o==="esriGeometryPolygon")e=u,i=u;else{const a=await $(n,t,o);a&&(e=a.width,i=a.height),o==="esriGeometryPolyline"&&(e=S),e=e!=null&&isFinite(e)?Math.min(e,M):u,i=i!=null&&isFinite(i)?Math.max(Math.min(i,M),R):u}return t.style==="legend"&&o==="esriGeometryPolyline"&&(e=S),{width:e,height:i}}async function $(n,t,o){const{feature:l,fieldMap:e,viewParams:i}=t.cimOptions||t,a=await F.resolveSymbolOverrides(n.data,l,null,e,o,null,i);if(!a)return null;(n=n.clone()).data={type:"CIMSymbolReference",symbol:a},n.data.primitiveOverrides=void 0;const r=[];return d.fetchResources(a,h.resourceManager,r),d.fetchFonts(a,h.resourceManager,r),r.length>0&&await Promise.all(r),d.getEnvelope(a,null,h.resourceManager)}async function K(n,t={}){const{node:o,opacity:l,symbolConfig:e}=t,i=e!=null&&typeof e=="object"&&"isSquareFill"in e&&e.isSquareFill,a=t.cimOptions||t,r=a.geometryType||z(n?.data?.symbol),f=await V(n,t,r),{feature:C,fieldMap:P}=a,I=i||r!=="esriGeometryPolygon"?"preview":"legend",y=await h.rasterizeCIMSymbolAsync(n,C,f,I,P,r,null,a.viewParams,a.allowScalingUp);if(!y)return null;const{width:L,height:j}=y,c=document.createElement("canvas");c.width=L,c.height=j,c.getContext("2d").putImageData(y,0,0);const p=v(f.width),g=v(f.height),s=new Image(p,g);s.src=c.toDataURL(),s.ariaLabel=t.ariaLabel??null,s.alt=t.ariaLabel??"",l!=null&&(s.style.opacity=`${l}`);let m=s;if(t.effectView!=null){const x={shape:{type:"image",x:0,y:0,width:p,height:g,src:s.src},fill:null,stroke:null,offset:[0,0]};m=O([[x]],[p,g],{effectView:t.effectView,ariaLabel:t.ariaLabel})}return o&&m&&o.appendChild(m),m}export{K as previewCIMSymbol};
