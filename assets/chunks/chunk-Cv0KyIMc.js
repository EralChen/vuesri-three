import{c as y,o as u,T as H}from"./chunk-DhngCxSs.js";import{u as E,r as V,s as $,t as A,V as R,S as M,P as k,A as L,D as S,e as x,W as N,f as w}from"./chunk-DY5FnirW.js";import{rx as P,ry as v}from"./chunk-JaFSy54E.js";import"./chunk-D_yTKJJf.js";import{d as g,x as j,o as z,R as _,r as b,Q as B,j as D,b as O,c as W,k as F,K as G}from"./chunk-DW0GXzYX.js";class q{constructor(){this._renderers=new P}add(e,r){const t={view:e,setup:typeof r.setup=="function"?n=>r.setup(n):null,dispose:typeof r.dispose=="function"?n=>r.dispose(n):null};typeof r.render=="function"&&(this._renderers.set(e,r,new v({...t,renderFunc:n=>r.render(n),produces:"opaque-color"})),t.setup=t.dispose=null),typeof r.renderTransparent=="function"&&this._renderers.set(e,r,new v({...t,renderFunc:n=>r.renderTransparent(n),produces:"transparent-color"}))}remove(e,r){const t=this._renderers.get(e,r);t&&(this._renderers.delete(e,r),t.destroy())}}const K=new q;function Q(s,e){K.add(s,e)}function U(s){s._stage.renderView.requestRender()}const I={arrowHelper:{type:Boolean,default:!1}},J=g({name:"VathThreeRendererEvents",props:I,setup(s){const e=E(),r=y(),t=r[u],n=e[u];class c extends H{constructor(i,a){super(),this.raycaster=new $,this.camera=e.threeCamera,this.scene=e.scene,this.eventName=i,this.handler=a,this.raycaster.camera=this.camera}add(){const i=async a=>{const l=a.event.mapPoint||r.toMap(a.event);await this.updateRaycaster(l),this.handler(a)};t.on(this.eventName,i),this.removeHandler=()=>{t.off(this.eventName,i)}}async updateRaycaster(i){const[a,l,C]=await A(r,[i]),f=this.camera.position.clone(),T=new R(a,l,C).sub(f).normalize();this.raycaster.set(f,T)}}const h=new c("click",async function(o){const i=this.raycaster.intersectObjects(this.scene.children);if(s.arrowHelper){const a=new V(this.raycaster.ray.direction,this.raycaster.ray.origin,1e5,16711680);this.scene.add(a)}n.emit("click",{...o,view:o.view,raycaster:this.raycaster,features:i,feature:i[0],threeRenderer:e})}),m=new c("pointer-move",async function(o){const i=this.raycaster.intersectObjects(this.scene.children);n.emit("pointer-move",{...o,view:o.view,raycaster:this.raycaster,features:i,feature:i[0],threeRenderer:e})});return j(()=>{h.add(),m.add()}),z(()=>{h.remove(),m.remove()}),{}}});function X(s,e,r,t,n,c){return b(s.$slots,"default")}const d=_(J,[["render",X]]);d.install=s=>{s.component(d.name,d)};function Y(s){return{all:s=s||new Map,on:function(e,r){var t=s.get(e);t?t.push(r):s.set(e,[r])},off:function(e,r){var t=s.get(e);t&&(r?t.splice(t.indexOf(r)>>>0,1):s.set(e,[]))},emit:function(e,r){var t=s.get(e);t&&t.slice().map(function(n){n(r)}),(t=s.get("*"))&&t.slice().map(function(n){n(e,r)})}}}const Z={axesHelper:{type:Boolean,default:!1}},ee={load:s=>s},re=g({name:"VathThreeRenderer",components:{VathThreeRendererEvents:d},props:Z,emits:ee,setup(s,{emit:e}){const r=y(),t=new se({view:r,axesHelper:s.axesHelper});return t[u]=Y(),globalThis.__VA_THREE_RENDERER__=t,B("vathThreeRenderer",t),e("load",{view:r,renderer:t}),{}}});function te(s,e,r,t,n,c){const h=D("VathThreeRendererEvents");return O(),W(G,null,[F(h),b(s.$slots,"default")],64)}const p=_(re,[["render",te]]);class se{constructor(e){this.layers=new ne,this.scene=new M,this.threeCamera=new k,this.ambient=new L(16777215,.5),this.sun=new S(16777215,.5),this.view=e.view,e.axesHelper&&this.scene.add(new x(1e7)),Q(e.view,this)}getRenderer(){if(!this.renderer)throw new Error("no renderer available");return this.renderer}setup(e){if(!e)throw new Error("no context passed to setup, cannot work that way");this.renderer=new N({context:e.gl,premultipliedAlpha:!1,preserveDrawingBuffer:!0}),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setViewport(0,0,this.view.width,this.view.height),this.resize(),this.view.watch(["width","height"],()=>{this.resize()}),this.renderer.autoClear=!1,this.renderer.autoClearDepth=!1,this.renderer.autoClearStencil=!1,this.renderer.autoClearColor=!1,this.scene.add(this.ambient),this.scene.add(this.sun),this.layers.forEach(r=>{r.setup({context:e,renderer:this.renderer,scene:this.scene,view:this.view})}),e.resetWebGLState()}render(e){this.threeCamera.position.set(e.camera.eye[0],e.camera.eye[1],e.camera.eye[2]),this.threeCamera.up.set(e.camera.up[0],e.camera.up[1],e.camera.up[2]),this.threeCamera.lookAt(new R(e.camera.center[0],e.camera.center[1],e.camera.center[2])),this.threeCamera.projectionMatrix.fromArray(e.camera.projectionMatrix);const r=e.sunLight;this.sun.position.set(r.direction[0],r.direction[1],r.direction[2]),this.sun.intensity=r.diffuse.intensity,this.sun.color=new w(r.diffuse.color[0],r.diffuse.color[1],r.diffuse.color[2]),this.ambient.intensity=r.ambient.intensity,this.ambient.color=new w(r.ambient.color[0],r.ambient.color[1],r.ambient.color[2]);const t={context:e,renderer:this.renderer,scene:this.scene,view:this.view};this.layers.forEach(n=>{n.render?.(t),n.animate?.(t)}),this.renderer?.resetState(),e.bindRenderTarget(),this.renderer?.render(this.scene,this.threeCamera),U(this.view),e.resetWebGLState()}dispose(e){this.layers.forEach(r=>{r.dispose({context:e,renderer:this.renderer,scene:this.scene,view:this.view})}),this.scene.remove(this.ambient),this.scene.remove(this.sun),this.ambient.dispose(),this.sun.dispose(),this.renderer?.dispose()}resize(){const e=this.view.width/this.view.height,r=this.getRenderer();isNaN(e)||(this.threeCamera.aspect=e,this.threeCamera.updateProjectionMatrix(),r.setSize(this.view.width,this.view.height))}}class ne extends Array{add(e){this.push(e)}remove(e){const r=this.indexOf(e);r>-1&&this.splice(r,1)}removeAll(){this.length=0}}p.install=s=>{s.component(p.name||"VathThreeRenderer",p)};export{ne as T,p as V,d as a,Y as m};
