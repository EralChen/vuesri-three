import{c as l,o as m}from"./chunk-DhngCxSs.js";import{a as p,m as u,T as f}from"./chunk-Cv0KyIMc.js";import{gE as w,a9 as v}from"./chunk-JaFSy54E.js";import{e as R}from"./chunk-D_yTKJJf.js";import{S as y,P as C,A as _,D as b,e as g,W as x,f as c}from"./chunk-DY5FnirW.js";import{d as E,Q as d,R as T,j as N,b as S,c as V,k as P,r as A,K as L}from"./chunk-DW0GXzYX.js";const D={axesHelper:{type:Boolean,default:!1}},H={load:e=>e},$=E({name:"VathThreeRenderNode",components:{VathThreeRendererEvents:p},props:D,emits:H,setup(e,{emit:r}){const s=l(),t=new o({view:s,axesHelper:e.axesHelper});return t[m]=u(),globalThis.__VA_THREE_RENDERER__=t,d("vathThreeRenderer",t),d("vathThreeRenderNode",t),r("load",{view:s,renderer:t}),{}}});function j(e,r,s,t,i,a){const n=N("VathThreeRendererEvents");return S(),V(L,null,[P(n),A(e.$slots,"default")],64)}const h=T($,[["render",j]]);var z=Object.defineProperty,B=Object.getOwnPropertyDescriptor,O=(e,r,s,t)=>{for(var i=t>1?void 0:t?B(r,s):r,a=e.length-1,n;a>=0;a--)(n=e[a])&&(i=(t?n(r,s,i):n(i))||i);return t&&i&&z(r,s,i),i};let o=class extends w{constructor(e){super(e),this.consumes={required:[]},this.produces="composite-color",this.layers=new f,this.scene=new y,this.threeCamera=new C,this.ambient=new _(16777215,.5),this.sun=new b(16777215,.5),e.axesHelper&&this.scene.add(new g(1e7))}getRenderer(){if(!this.renderer)throw new Error("no renderer available");return this.renderer}initialize(){this.addHandles(v(()=>this.view.ready,e=>{e?this.setup():this.dispose()},{initial:!0}))}setup(){const e=this.gl;this.renderer=new x({context:e,premultipliedAlpha:!1,preserveDrawingBuffer:!0}),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setViewport(0,0,this.view.width,this.view.height),this.resize(),this.view.watch(["width","height"],()=>{this.resize()}),this.renderer.autoClear=!1,this.renderer.autoClearDepth=!1,this.renderer.autoClearStencil=!1,this.renderer.autoClearColor=!1,this.scene.add(this.ambient),this.scene.add(this.sun);const r={context:this,renderer:this.renderer,scene:this.scene,view:this.view,renderNode:this};this.layers.forEach(t=>{t.setup(r)});const s=()=>{this.layers.forEach(t=>{t.animate?.(r)}),requestAnimationFrame(s)};s(),this.resetWebGLState()}render(e){this.renderer?.resetState();const r=this.bindRenderTarget();return this.syncCamera(),this.syncSunlight(),this.layers.forEach(s=>{s.render?.({renderer:this.getRenderer(),scene:this.scene,view:this.view,renderNode:this,inputs:e,context:this})}),this.renderer?.render(this.scene,this.threeCamera),this.resetWebGLState(),r}dispose(){this.layers.forEach(e=>{e.dispose({context:this,renderer:this.renderer,scene:this.scene,view:this.view,renderNode:this})}),this.scene.remove(this.ambient),this.scene.remove(this.sun),this.ambient.dispose(),this.sun.dispose(),this.renderer?.dispose()}destroy(){this.dispose(),super.destroy()}syncCamera(){this.threeCamera.position.set(this.camera.eye[0],this.camera.eye[1],this.camera.eye[2]),this.threeCamera.up.set(this.camera.up[0],this.camera.up[1],this.camera.up[2]),this.threeCamera.lookAt(this.camera.center[0],this.camera.center[1],this.camera.center[2]),this.threeCamera.projectionMatrix.fromArray(this.camera.projectionMatrix)}syncSunlight(){const e=this.sunLight;this.sun.position.set(e.direction[0],e.direction[1],e.direction[2]),this.sun.intensity=e.diffuse.intensity,this.sun.color=new c(e.diffuse.color[0],e.diffuse.color[1],e.diffuse.color[2]),this.ambient.intensity=e.ambient.intensity,this.ambient.color=new c(e.ambient.color[0],e.ambient.color[1],e.ambient.color[2])}resize(){const e=this.view.width/this.view.height,r=this.getRenderer();isNaN(e)||(this.threeCamera.aspect=e,this.threeCamera.updateProjectionMatrix(),r.setSize(this.view.width,this.view.height))}};o=O([R("vuesri.three.ThreeRenderNode")],o);h.install=e=>{e.component(h.name||"VathThreeRenderNode",h)};export{h as V};
