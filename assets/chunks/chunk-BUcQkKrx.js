import{a4 as C,a6 as q,a7 as z,mC as T,W as _,dB as v,mD as c,mu as A,mv as V,a9 as F,P as E,cv as y,mx as g,d5 as b,mE as G,j0 as D,dX as O,ci as f,cl as l,mF as w,mw as M,ew as x,kz as j,dF as H,mG as I,cj as Q,kP as p,my as S,mH as P,dH as k,dC as L,dD as N,dE as U,gD as Y,iQ as B}from"./chunk-JaFSy54E.js";import{y as R,e as W,S as X}from"./chunk-D_yTKJJf.js";import{t as J}from"./chunk-CSSAm_KD.js";class K{constructor(e){this._resourceFactory=e,this._resources=null,this._visible=!0,this._attached=!1,this._renderGroup=T.Outline}destroy(){this._destroyResources()}get resources(){return this._resources!=null?this._resources.external:null}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this._syncGeometriesToRenderer())}get attached(){return this._attached}set attached(e){e!==this._attached&&(this._attached=e,this._createOrDestroyResources())}get renderGroup(){return this._renderGroup}set renderGroup(e){this._renderGroup=e;const r=this._resources?.layerView;r&&(r.renderGroup=e)}recreate(){this.attached&&this._createResources()}recreateGeometry(){this._resourceFactory.recreateGeometry?this._resources!=null&&(this._ensureRenderGeometriesRemoved(),this._resourceFactory.recreateGeometry(this._resources.external),this._syncGeometriesToRenderer()):this.recreate()}_createOrDestroyResources(){this._attached?this._resources==null&&this._createResources():this._destroyResources()}_createResources(){this._destroyResources();const e=this._resourceFactory.createResources(),r=new h({view:this._resourceFactory.view,renderGroup:this._renderGroup}),t=this._resourceFactory.view.basemapTerrain?.overlayManager;this._resources={layerView:new h({view:this._resourceFactory.view,renderGroup:this._renderGroup}),external:e,geometriesAdded:!1},t&&(this._resources.drapeSourceRenderer=t.registerGeometryDrapeSource(r)),this._syncGeometriesToRenderer()}_destroyResources(){if(this._resources==null)return;this._ensureRenderGeometriesRemoved();const e=this._resourceFactory.view.basemapTerrain?.overlayManager;e&&e.unregisterDrapeSource(this._resources.layerView),this._resourceFactory.destroyResources(this._resources.external),this._resources=null}_syncGeometriesToRenderer(){this._visible?this._ensureRenderGeometriesAdded():this._ensureRenderGeometriesRemoved()}_ensureRenderGeometriesRemoved(){this._resources?.drapeSourceRenderer!=null&&this._resources.geometriesAdded&&(this._resources.drapeSourceRenderer.removeGeometries(this._resources.external.geometries,v.UPDATE),this._resources.geometriesAdded=!1)}_ensureRenderGeometriesAdded(){this._resources?.drapeSourceRenderer!=null&&(this._resources.geometriesAdded||(this._resources.drapeSourceRenderer.addGeometries(this._resources.external.geometries,v.UPDATE),this._resources.geometriesAdded=!0))}}let h=class extends C(X){constructor(n){super(n),this.drapeSourceType=q.Features,this.updatePolicy=z.SYNC,this.renderGroup=T.Outline}};_([R({constructOnly:!0})],h.prototype,"view",void 0),_([R({readOnly:!0})],h.prototype,"drapeSourceType",void 0),_([R()],h.prototype,"renderGroup",void 0),h=_([W("DrapedVisualElementLayerView")],h);class Z{constructor(e){this._resourceFactory=e,this._resources=null,this._visible=!0,this._attached=!1}destroy(){this._destroyResources()}get object(){return this._resources!=null?this._resources.object:null}get resources(){return this._resources!=null?this._resources.external:null}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this._syncVisible())}get attached(){return this._attached}set attached(e){e!==this._attached&&(this._attached=e,this._createOrDestroyResources())}recreate(){this.attached&&this._createResources()}recreateGeometry(){if(!this._resourceFactory.recreateGeometry)return void this.recreate();const e=this._resourceFactory.view._stage;if(this._resources==null||!e)return;const r=this._resources.object;this._resources.external.forEach(t=>{t.type!==c.Mesh&&t.type!==c.Line&&t.type!==c.Point||e.remove(t)}),r.removeAllGeometries(),this._resourceFactory.recreateGeometry(this._resources.external,r,this._resources.layer),this._resources.external.forEach(t=>{t.type!==c.Mesh&&t.type!==c.Line&&t.type!==c.Point||e.add(t)})}_createOrDestroyResources(){this._attached?this._resources||this._createResources():this._destroyResources()}_createResources(){this._destroyResources();const e=this._resourceFactory,r=e.view,t=r._stage;if(!t)return;const s=new A(t,{pickable:!1,updatePolicy:z.SYNC}),i=new V({castShadow:!1}),o=e.createResources(i,s);o.forEach(a=>{t.add(a),a.type===c.Texture&&a.load(t.renderView.renderingContext)}),t.add(i),s.add(i);const d=e.cameraChanged,m=d?F(()=>r.state.camera,a=>d(a),E):null;this._resources={layer:s,object:i,external:o,cameraHandle:m},this._syncVisible()}_destroyResources(){if(this._resources==null)return;const e=this._resourceFactory.view._stage;e&&(e.remove(this._resources.object),this._resources.layer.destroy(),this._resources.external.forEach(r=>{e.remove(r),r.type===c.Texture&&r.unload()})),this._resources.object.dispose(),this._resources.cameraHandle?.remove(),this._resourceFactory.destroyResources(this._resources.external),this._resources=null}_syncVisible(){this._resources!=null&&(this._resources.object.visible=this._visible)}}class ee extends J{constructor(e){super(e),this._isDraped=!1,this.object3dResources=new Z(this.createObject3DResourceFactory(e.view)),this.drapedResources=new K(this.createDrapedResourceFactory(e.view)),this.isDraped=e.isDraped??!1}get isDraped(){return this._isDraped}set isDraped(e){e!==this._isDraped&&(this._isDraped=e,this.object3dResources.attached=this.attached&&!e,this.drapedResources.attached=this.attached&&e)}get renderGroup(){return this.drapedResources.renderGroup}set renderGroup(e){this.drapedResources.renderGroup=e}createResources(){this.object3dResources.attached=!this._isDraped,this.drapedResources.attached=this._isDraped}destroyResources(){this.object3dResources.attached=!1,this.drapedResources.attached=!1}recreate(){this.object3dResources.recreate(),this.drapedResources.recreate()}recreateGeometry(){this.object3dResources.recreateGeometry(),this.drapedResources.recreateGeometry()}destroy(){this.object3dResources.destroy(),this.drapedResources.destroy(),super.destroy()}updateVisibility(e){this.object3dResources.visible=e,this.drapedResources.visible=e}}class oe extends ee{constructor(e){super(e),this._maxSize=0,this._position=y(),this._up=y(),this._right=y(),this._renderOccluded=g.OccludeAndTransparent,this._color=b(1,0,0,1),this._outlineColor=b(0,0,0,1),this._outlineSize=0,this._size=32,this._outlineRenderOccluded=g.Opaque,this.applyProperties(e)}createObject3DResourceFactory(e){return{view:e,createResources:r=>this._createObject3DResources(r),destroyResources:()=>{},cameraChanged:()=>this._updateTransformObject3D()}}createDrapedResourceFactory(e){return{view:e,createResources:()=>this._createDrapedResources(),destroyResources:r=>this._destroyDrapedResources(r)}}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateQuadMaterial())}get color(){return this._color}set color(e){G(this._color,e),this._updateQuadMaterial()}get outlineColor(){return this._outlineColor}set outlineColor(e){G(this._outlineColor,e),this._updateOutlineMaterial()}get outlineSize(){return this._outlineSize}set outlineSize(e){const r=this._outlineSize===0!=(e===0);this._outlineSize=e,r?this.recreateGeometry():this._updateOutlineMaterial()}get size(){return this._size}set size(e){e!==this._size&&(this._size=e,this._updateTransform())}get outlineRenderOccluded(){return this._outlineRenderOccluded}set outlineRenderOccluded(e){this._outlineRenderOccluded=e,this._updateOutlineMaterial()}set geometry({previous:e,center:r,next:t}){this._maxSize=Math.min(D(r,e),D(r,t))/3,O(this._up,f(this._up,e,r)),O(this._right,f(this._right,t,r)),l(this._position,r),this.recreateGeometry()}_createObject3DResources(e){const r=new w(this._quadMaterialParameters),t=this._outlineSize===0?void 0:new M(this._outlineMaterialParameters);return this._createObject3DGeometries(e,r,t),{quadMaterial:r,outlineMaterial:t,forEach:s=>{s(r),t&&s(t)}}}_createObject3DGeometries(e,r,t){if(x(this._up,j)&&x(this._right,j))return;const s=this._createGeometries(r,t);for(const i of s)e.addGeometry(i);this._updateTransformObject3D(e)}_createDrapedResources(){const e=new w(this._quadMaterialParameters),r=this._outlineSize===0?void 0:new M(this._outlineMaterialParameters),t=this._createGeometries(e,r).map(s=>new H(s));return this._setTransformDraped(t),{quadMaterial:e,outlineMaterial:r,geometries:t,pixelRatioHandle:F(()=>this.view.state.contentPixelRatio,()=>{this.drapedResources.recreateGeometry()})}}_destroyDrapedResources(e){e.pixelRatioHandle.remove(),e.geometries=[]}_createGeometries(e,r){const{up:t,right:s,corner:i}=this._getVertices(),o=this._quadGeometryData(t,s,i,e);return r?[o,I(r,[t,i,s])]:[o]}_getVertices(){let e=this._up,r=this._right;const t=Q(p.get(),e,r);return this.isDraped&&(e=l(p.get(),e),r=l(p.get(),r),e[2]=0,r[2]=0,t[2]=0),{up:e,right:r,corner:t}}_updateTransform(){this.isDraped?this.drapedResources.recreateGeometry():this._updateTransformObject3D()}_updateTransformObject3D(e=this.object3dResources.object){if(!e)return;const r=this.view.state.camera,t=this._size*r.computeScreenPixelSizeAt(this._position),s=Math.min(this._maxSize,t);S(u,this._position),P(u,u,[s,s,s]),e.transformation=u}_setTransformDraped(e){if(e.length===0)return;const{view:{basemapTerrain:{overlayManager:r},state:{contentPixelRatio:t}}}=this,{_position:s,_size:i}=this,o=l(p.get(),s);o[2]=k;const d=re;d.spatialReference=r.renderer.spatialReference,d.x=o[0],d.y=o[1];const m=i*(this.view.overlayPixelSizeInMapUnits(d)*t),a=Math.min(this._maxSize,m);S(u,o),P(u,u,[a,a,1]);for(const $ of e)$.transformation=u}_quadGeometryData(e,r,t,s){return new L(s,[[N.POSITION,new U([0,0,0,...r,...e,...t],[0,1,2,1,2,3],3,!0)]])}get _quadMaterialParameters(){return{color:this._color,forceTransparentMode:!0,writeDepth:!1,polygonOffset:!0,renderOccluded:this._renderOccluded,isDecoration:this.isDecoration}}_updateQuadMaterial(){this.object3dResources.resources?.quadMaterial.setParameters(this._quadMaterialParameters),this.drapedResources.resources?.quadMaterial.setParameters(this._quadMaterialParameters)}get _outlineMaterialParameters(){return{color:this._outlineColor,width:this._outlineSize,renderOccluded:this._outlineRenderOccluded,isDecoration:this.isDecoration}}_updateOutlineMaterial(){this.object3dResources.resources?.outlineMaterial?.setParameters(this._outlineMaterialParameters),this.drapedResources.resources?.outlineMaterial?.setParameters(this._outlineMaterialParameters)}}const u=Y(),re=B(0,0,void 0,null);export{ee as t,oe as z};
