import{cT as y,cX as u,e5 as g,e6 as f,cV as b,e7 as I,W as m,cU as R}from"./chunk-JaFSy54E.js";import{s as w,y as d,e as z}from"./chunk-D_yTKJJf.js";import{n as T}from"./chunk-DaKMKTem.js";import{c as v}from"./chunk-OSl90fp-.js";import{p as x}from"./chunk-BUK3AiRY.js";import"./chunk-FKPdDv5g.js";let n=class extends x(y(v(T(R)))){constructor(){super(...arguments),this.type="imagery-tile-3d",this.isAlignedMapTile=!0}initialize(){this.layer.increaseRasterJobHandlerUsage(),this.fullExtent==null&&this.addResolvingPromise(Promise.reject(new w("layerview:spatial-reference-incompatible","The layer extent cannot be projected to the view's spatial reference",{layer:this.layer})));const e=u(()=>this.view?.basemapTerrain?.tilingSchemeLocked).then(()=>{const t=this.view.basemapTerrain.tilingScheme,i=this.layer.tileInfo,r=["png","png24","png32","jpg","mixed"].includes(i.format)&&t.compatibleWith(i);this.isAlignedMapTile=r;const s=r?i:t.toTileInfo();this.tileInfo=s,this._updatingHandles.add(()=>[this.layer.renderer,this.layer.interpolation,this.layer.bandIds,this.layer.multidimensionalDefinition,this.layer.multidimensionalSubset,this.layer.rasterFunction,this.timeExtent],()=>this.refresh())});this.addResolvingPromise(e)}destroy(){this.layer.decreaseRasterJobHandlerUsage(),this.view=null}get _blankTile(){const e=document.createElement("canvas"),t=e.getContext("2d"),[i,r]=this.tileInfo.size;return e.width=i,e.height=r,t.clearRect(0,0,i,r),t.getImageData(0,0,i,r)}get imageFormatIsOpaque(){return this.layer.tileInfo.format==="jpg"}get hasMixedImageFormats(){return this.layer.tileInfo.format==="mixed"}get dataLevelRange(){const e=this.layer.tileInfo,t=this.tileInfo.lodAt(0)?.scale,i=this.layer.tileInfo.lodAt(e.lods.length-1)?.scale;return this.levelRangeFromScaleRange(t,i)}_getfullExtent(){return g(this.layer.serviceRasterInfo,this.view.basemapTerrain?.spatialReference!=null?this.view.basemapTerrain.spatialReference:this.view.spatialReference)}async fetchTile(e,t,i,r){const s=this.tileInfo,c=this._canSymbolizeInWebGL(),p={tileInfo:s,requestRawData:c,signal:r.signal,timeExtent:this.timeExtent,requestAsImageElement:this.isAlignedMapTile,noClip:!1},{layer:l}=this,o=await l.fetchTile(e,t,i,p);if(o instanceof HTMLImageElement)return o;let h=o?.pixelBlock;if(h==null)return this._blankTile;if(!c&&(h=await l.applyRenderer(o),h==null))return this._blankTile;const a=new f([e,t,i],h,s.size[0],s.size[1]);return c?(a.symbolizerRenderer=l.symbolizer.rendererJSON,a.symbolizerParameters=l.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(e)),a.transformGrid=o.transformGrid,a.bandIds=l.bandIds):(a.isRendereredSource=!0,a.bandIds=null),a.interpolation=l.interpolation,a}_getSymbolizerOptions(e){const t=this.tileInfo.lodAt(e).resolution;return{pixelBlock:null,isGCS:this.view.basemapTerrain?.spatialReference!=null?this.view.basemapTerrain.spatialReference.isGeographic:this.view.spatialReference.isGeographic,resolution:{x:t,y:t},bandIds:this.layer.bandIds}}ensureSymbolizerParameters(e){this._canSymbolizeInWebGL()&&JSON.stringify(e.symbolizerRenderer)!==JSON.stringify(this.layer.symbolizer.rendererJSON)&&(e.symbolizerParameters=this.layer.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(e.lij[0])))}createFetchPopupFeaturesQueryGeometry(e,t){return b(e,t,this.view)}refresh(){this.emit("data-changed")}async doRefresh(){this.suspended||this.emit("data-changed")}_canSymbolizeInWebGL(){const e=I(),{symbolizer:t}=this.layer,i=t.lookup?.colormapLut?.indexedColormap,r=!!this.layer.rasterFunction?.hasClipFunction,s=i&&i.length>4*(e.maxTextureSize||4906);return t.canRenderInWebGL&&!s&&!r}};m([d({readOnly:!0})],n.prototype,"_blankTile",null),m([d({readOnly:!0})],n.prototype,"imageFormatIsOpaque",null),m([d({readOnly:!0})],n.prototype,"hasMixedImageFormats",null),m([d({readOnly:!0})],n.prototype,"dataLevelRange",null),n=m([z("esri.views.3d.layers.ImageryTileLayerView3D")],n);const P=n;export{P as default};
